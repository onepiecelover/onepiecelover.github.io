<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"onepiecelover.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="嘻嘻">
<meta property="og:url" content="https://onepiecelover.github.io/index.html">
<meta property="og:site_name" content="嘻嘻">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Angle">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://onepiecelover.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>嘻嘻</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">嘻嘻</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/08/15/linux%E9%9A%A7%E9%81%93%E5%AE%9E%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/15/linux%E9%9A%A7%E9%81%93%E5%AE%9E%E9%AA%8C/" class="post-title-link" itemprop="url">linux隧道实验</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-08-15 18:15:54 / 修改时间：18:26:13" itemprop="dateCreated datePublished" datetime="2021-08-15T18:15:54+08:00">2021-08-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="隧道介绍"><a href="#隧道介绍" class="headerlink" title="隧道介绍"></a>隧道介绍</h3><blockquote>
<ul>
<li>为了在TCP/IP网络中传输其他协议的数据包。通过在源协议数据包上再套上一个IP协议头来实现，形成的IP数据包通过Internet后卸去IP头，还原成源协议数据包，传送给目的站点。</li>
</ul>
</blockquote>
<h3 id="隧道模式"><a href="#隧道模式" class="headerlink" title="隧道模式"></a>隧道模式</h3><blockquote>
<p>ps:一共有5种模式 ipip | gre | sit | isatap | vti</p>
<ul>
<li>ipip：即 IPv4 in IPv4，在 IPv4 报文的基础上再封装一个 IPv4 报文。</li>
<li>gre：即通用路由封装（Generic Routing Encapsulation），定义了在任意一种网络层协议上封装其他任意一种网络层协议的机制，IPv4 和 IPv6 都适用。</li>
<li>sit：和 ipip 类似，不同的是 sit 是用 IPv4 报文封装 IPv6 报文，即 IPv6 over IPv4。</li>
<li>isatap：即站内自动隧道寻址协议（Intra-Site Automatic Tunnel Addressing Protocol），和 sit 类似，也是用于 IPv6 的隧道封装。</li>
<li>vti：即虚拟隧道接口（Virtual Tunnel Interface），是 cisco 提出的一种 IPsec 隧道技术。</li>
</ul>
</blockquote>
<h3 id="实践-准备两台云主机"><a href="#实践-准备两台云主机" class="headerlink" title="实践-准备两台云主机"></a>实践-准备两台云主机</h3><blockquote>
<ul>
<li>10.9.142.136</li>
<li>10.9.29.68</li>
</ul>
</blockquote>
<h3 id="GRE模式-通用路由封装"><a href="#GRE模式-通用路由封装" class="headerlink" title="GRE模式(通用路由封装)"></a>GRE模式(通用路由封装)</h3><blockquote>
<ul>
<li>在10.9.29.68机器上执行以下命令</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">modprobe ipip</span><br><span class="line">modprobe ip_gre</span><br><span class="line">ip tunnel add tun0 mode gre local 10.9.29.68 remote 10.9.142.136 </span><br><span class="line">ip link set tun0 up</span><br><span class="line">ip addr add 192.168.10.1 peer 192.168.10.2 dev tun0</span><br><span class="line">ip route add 192.168.10.1/24 dev tun0</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>在10.9.142.136执行以下命令</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">modprobe ipip</span><br><span class="line">modprobe ip_gre</span><br><span class="line">ip tunnel add tun0 mode gre local 10.9.142.136 remote 10.9.29.68 </span><br><span class="line">ip link set tun0 up</span><br><span class="line">ip addr add 192.168.10.2 peer 192.168.10.1 dev tun0</span><br><span class="line">ip route add 192.168.10.1/24 dev tun0</span><br></pre></td></tr></table></figure>

<h3 id="查看隧道报文"><a href="#查看隧道报文" class="headerlink" title="查看隧道报文"></a>查看隧道报文</h3><blockquote>
<ul>
<li>在<code>10.9.142.136</code>机器上启动nginx服务</li>
<li>从<code>10.9.29.68</code>机器访问，命令 <code>curl192.168.10.2</code></li>
<li>抓包 <code>tcpdump host 10.9.142.136</code></li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">14:01:41.952193 IP 10-9-29-68 &gt; 10.9.142.136: GREv0, length 64: IP 10-9-29-68.35892 &gt; 192.168.10.2.http: Flags [S], seq 3964984022, win 27800, options [mss 1390,sackOK,TS val 4264166462 ecr 0,nop,wscale 7], length 0</span><br><span class="line">14:01:41.954756 IP 10.9.142.136 &gt; 10-9-29-68: GREv0, length 64: IP 192.168.10.2.http &gt; 10-9-29-68.35892: Flags [S.], seq 1878434104, ack 3964984023, win 28960, options [mss 1460,sackOK,TS val 972483763 ecr 4264166462,nop,wscale 7], length 0</span><br><span class="line">14:01:41.954865 IP 10-9-29-68 &gt; 10.9.142.136: GREv0, length 56: IP 10-9-29-68.35892 &gt; 192.168.10.2.http: Flags [.], ack 1, win 218, options [nop,nop,TS val 4264166464 ecr 972483763], length 0</span><br><span class="line">14:01:41.955084 IP 10-9-29-68 &gt; 10.9.142.136: GREv0, length 132: IP 10-9-29-68.35892 &gt; 192.168.10.2.http: Flags [P.], seq 1:77, ack 1, win 218, options [nop,nop,TS val 4264166464 ecr 972483763], length 76: HTTP: GET / HTTP/1.1</span><br><span class="line">14:01:41.955385 IP 10.9.142.136 &gt; 10-9-29-68: GREv0, length 56: IP 192.168.10.2.http &gt; 10-9-29-68.35892: Flags [.], ack 77, win 227, options [nop,nop,TS val 972483765 ecr 4264166464], length 0</span><br><span class="line">14:01:41.955538 IP 10.9.142.136 &gt; 10-9-29-68: GREv0, length 294: IP 192.168.10.2.http &gt; 10-9-29-68.35892: Flags [P.], seq 1:239, ack 77, win 227, options [nop,nop,TS val 972483765 ecr 4264166464], length 238: HTTP: HTTP/1.1 200 OK</span><br><span class="line">14:01:41.955546 IP 10-9-29-68 &gt; 10.9.142.136: GREv0, length 56: IP 10-9-29-68.35892 &gt; 192.168.10.2.http: Flags [.], ack 239, win 226, options [nop,nop,TS val 4264166465 ecr 972483765], length 0</span><br><span class="line">14:01:41.955615 IP 10.9.142.136 &gt; 10-9-29-68: GREv0, length 668: IP 192.168.10.2.http &gt; 10-9-29-68.35892: Flags [P.], seq 239:851, ack 77, win 227, options [nop,nop,TS val 972483765 ecr 4264166464], length 612: HTTP</span><br><span class="line">14:01:41.955625 IP 10-9-29-68 &gt; 10.9.142.136: GREv0, length 56: IP 10-9-29-68.35892 &gt; 192.168.10.2.http: Flags [.], ack 851, win 236, options [nop,nop,TS val 4264166465 ecr 972483765], length 0</span><br><span class="line">14:01:41.956800 IP 10-9-29-68 &gt; 10.9.142.136: GREv0, length 56: IP 10-9-29-68.35892 &gt; 192.168.10.2.http: Flags [F.], seq 77, ack 851, win 236, options [nop,nop,TS val 4264166466 ecr 972483765], length 0</span><br><span class="line">14:01:41.957046 IP 10.9.142.136 &gt; 10-9-29-68: GREv0, length 56: IP 192.168.10.2.http &gt; 10-9-29-68.35892: Flags [F.], seq 851, ack 78, win 227, options [nop,nop,TS val 972483767 ecr 4264166466], length 0</span><br><span class="line">14:01:41.957055 IP 10-9-29-68 &gt; 10.9.142.136: GREv0, length 56: IP 10-9-29-68.35892 &gt; 192.168.10.2.http: Flags [.], ack 852, win 236, options [nop,nop,TS val 4264166466 ecr 972483767], length 0</span><br></pre></td></tr></table></figure>


<h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://sites.google.com/site/emmoblin/linux-network-1/linux-zhongip-sui-dao">Linux中IP隧道</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1432489">什么是 IP 隧道，Linux 怎么实现隧道通信</a></li>
</ul>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/08/15/%E8%B7%A8namespace%E9%80%9A%E4%BF%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/15/%E8%B7%A8namespace%E9%80%9A%E4%BF%A1/" class="post-title-link" itemprop="url">跨namespace通信</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-08-15 18:14:31 / 修改时间：18:26:16" itemprop="dateCreated datePublished" datetime="2021-08-15T18:14:31+08:00">2021-08-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="netns"><a href="#netns" class="headerlink" title="netns"></a>netns</h2><blockquote>
<ul>
<li>对于每个 <code>network namespace</code> 来说，它会有自己独立的网卡、路由表、ARP 表、iptables 等和网络相关的资源</li>
</ul>
</blockquote>
<h2 id="ip-netns"><a href="#ip-netns" class="headerlink" title="ip netns"></a>ip netns</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ip netns help</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Usage: ip netns list</span><br><span class="line">       ip netns add NAME</span><br><span class="line">       ip netns set NAME NETNSID</span><br><span class="line">       ip [-all] netns delete [NAME]</span><br><span class="line">       ip netns identify [PID]</span><br><span class="line">       ip netns pids NAME</span><br><span class="line">       ip [-all] netns exec [NAME] cmd ...</span><br><span class="line">       ip netns monitor</span><br><span class="line">       ip netns list-id</span><br></pre></td></tr></table></figure>

<h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><h3 id="veth-pair通信"><a href="#veth-pair通信" class="headerlink" title="veth pair通信"></a>veth pair通信</h3><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#创建ns2</span><br><span class="line">ip netns add ns2 </span><br><span class="line"></span><br><span class="line">#再次查看</span><br><span class="line">ip netns l</span><br><span class="line">ns1</span><br><span class="line">ns2</span><br><span class="line"></span><br><span class="line">#增加veth设备</span><br><span class="line">ip link add type veth </span><br><span class="line"></span><br><span class="line">#增加带名字的veth设备</span><br><span class="line">ip link add veth0 type veth peer name veth1</span><br><span class="line"></span><br><span class="line">#把这对 veth pair 分别放到已经两个 namespace</span><br><span class="line">ip link set veth0 netns ns1</span><br><span class="line">ip link set veth1 netns ns2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#给这对 veth pair 配置上 ip 地址，并启用它们</span><br><span class="line">ip netns exec ns1 ip link set veth0 up</span><br><span class="line">ip netns exec ns1 ip addr add 172.16.1.1/24 dev veth0</span><br><span class="line"></span><br><span class="line">ip netns exec ns2 ip link set veth1 up</span><br><span class="line">ip netns exec ns2 ip addr add 172.16.1.2/24 dev veth1</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip netns exec ns2 ping 172.16.1.1 -c 4</span><br></pre></td></tr></table></figure>

<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#直接抓包，啥也抓不到</span><br><span class="line">tcpdump host 172.16.1.1</span><br><span class="line"></span><br><span class="line">#进入ns里面抓包</span><br><span class="line">ip netns exec ns1 tcpdump host 172.16.1.1</span><br><span class="line"></span><br><span class="line">10:49:46.218008 IP 172.16.1.2 &gt; 10-9-153-165: ICMP echo request, id 10798, seq 1, length 64</span><br><span class="line">10:49:46.218024 IP 10-9-153-165 &gt; 172.16.1.2: ICMP echo reply, id 10798, seq 1, length 64</span><br><span class="line">10:49:47.250282 IP 172.16.1.2 &gt; 10-9-153-165: ICMP echo request, id 10798, seq 2, length 64</span><br><span class="line">10:49:47.250304 IP 10-9-153-165 &gt; 172.16.1.2: ICMP echo reply, id 10798, seq 2, length 64</span><br><span class="line">10:49:48.274292 IP 172.16.1.2 &gt; 10-9-153-165: ICMP echo request, id 10798, seq 3, length 64</span><br><span class="line">10:49:48.274315 IP 10-9-153-165 &gt; 172.16.1.2: ICMP echo reply, id 10798, seq 3, length 64</span><br><span class="line">10:49:49.298327 IP 172.16.1.2 &gt; 10-9-153-165: ICMP echo request, id 10798, seq 4, length 64</span><br><span class="line">10:49:49.298349 IP 10-9-153-165 &gt; 172.16.1.2: ICMP echo reply, id 10798, seq 4, length 64</span><br></pre></td></tr></table></figure>

<h3 id="bridge（网桥）"><a href="#bridge（网桥）" class="headerlink" title="bridge（网桥）"></a>bridge（网桥）</h3><blockquote>
<p><code>veth pair</code> 可以实现两个 <code>network namespace</code> 之间的通信，但是当多个 <code>namespace</code> 需要通信的时候，就无能为力了。此时就需要<code>bridge</code></p>
</blockquote>
<h4 id="配置网桥"><a href="#配置网桥" class="headerlink" title="配置网桥"></a>配置网桥</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建网桥</span><br><span class="line">ip link add br0 type bridge</span><br><span class="line"># 拉起网桥</span><br><span class="line">ip link set dev br0 up</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="配置net0"><a href="#配置net0" class="headerlink" title="配置net0"></a>配置net0</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 创建net0</span><br><span class="line">ip netns add net0</span><br><span class="line"></span><br><span class="line"># 创建veth</span><br><span class="line">ip link add type veth</span><br><span class="line"></span><br><span class="line"># veth1 移动至net0</span><br><span class="line">ip link set dev veth1 netns net0</span><br><span class="line"></span><br><span class="line"># 修改veth1的名字为eth0</span><br><span class="line">ip netns exec net0 ip link set dev veth1 name eth0</span><br><span class="line"></span><br><span class="line"># 给eth0配置ip</span><br><span class="line">ip netns exec net0 ip addr add 192.168.10.1/24 dev eth0</span><br><span class="line"># 拉起eth0</span><br><span class="line">ip netns exec net0 ip link set dev eth0 up</span><br><span class="line"></span><br><span class="line"># veth0连接到br0</span><br><span class="line">ip link set dev veth0 master br0</span><br><span class="line"># 拉起br0</span><br><span class="line">ip link set dev veth0 up</span><br></pre></td></tr></table></figure>

<h4 id="配置net1-同net0"><a href="#配置net1-同net0" class="headerlink" title="配置net1(同net0)"></a>配置net1(同net0)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ip netns add net1</span><br><span class="line">ip link add type veth</span><br><span class="line">ip link set dev veth2 netns net1</span><br><span class="line">ip netns exec net1 ip link set dev veth2 name eth0</span><br><span class="line">ip netns exec net1 ip addr add 192.168.10.2/24 dev eth0</span><br><span class="line">ip netns exec net0 ip link set dev eth0 up</span><br><span class="line">ip link set dev veth3 master br0</span><br><span class="line">ip link set dev veth3 up</span><br></pre></td></tr></table></figure>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ip netns exec net1 ping 192.168.10.1 -c 4</span><br><span class="line"></span><br><span class="line">PING 192.168.10.1 (192.168.10.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.10.1: icmp_seq=1 ttl=64 time=0.087 ms</span><br><span class="line">64 bytes from 192.168.10.1: icmp_seq=2 ttl=64 time=0.082 ms</span><br><span class="line">^C</span><br><span class="line">--- 192.168.10.1 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1003ms</span><br><span class="line">rtt min/avg/max/mdev = 0.082/0.084/0.087/0.009 ms</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://cizixs.com/2017/02/10/network-virtualization-network-namespace/">Linux 网络虚拟化： network namespace 简介</a></li>
</ul>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/08/15/git%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/15/git%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">git简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-08-15 17:24:17 / 修改时间：18:26:17" itemprop="dateCreated datePublished" datetime="2021-08-15T17:24:17+08:00">2021-08-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="git介绍"><a href="#git介绍" class="headerlink" title="git介绍"></a>git介绍</h3><blockquote>
<p>Git是目前世界上最先进的分布式版本控制系统。能记录每次文件的改动。</p>
</blockquote>
<h3 id="git的诞生"><a href="#git的诞生" class="headerlink" title="git的诞生"></a>git的诞生</h3><blockquote>
<p>开发Samba的Andrew试图破解BitKeeper的协议（这么干的其实也不只他一个），被BitMover公司发现了（监控工作做得不错！），于是BitMover公司怒了，要收回Linux社区的免费使用权。Linus花了两周时间自己用C写了一个分布式版本控制系统，这就是Git！一个月之内，Linux系统的源码已经由Git管理了。</p>
</blockquote>
<h3 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h3><blockquote>
<p>可以参考<code>https://github.com/git/git</code>。但是一般不。</p>
<ul>
<li>大部分linux系统都已经自带了git，如果没有的话执行 centos下 <code>yum install git</code> or ubuntu下 <code>apt-get install git</code></li>
<li>在Windows上，二进制安装</li>
</ul>
</blockquote>
<h3 id="设置git"><a href="#设置git" class="headerlink" title="设置git"></a>设置git</h3><blockquote>
<p>在我们能用git工作之前，我们需要做个一次性的配置。为了git能跟踪到谁做了修改，我们需要设置你的用户名。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;your_username&quot;</span><br><span class="line">git config --global user.email &quot;your_email@domain.com&quot;</span><br></pre></td></tr></table></figure>

<h3 id="创建一个本地代码库"><a href="#创建一个本地代码库" class="headerlink" title="创建一个本地代码库"></a>创建一个本地代码库</h3><blockquote>
<ul>
<li>作为例子，我们会假装我们有一个网站（无所谓技术）存在于我们机器上的<code>workspace</code>文件夹下的<code>my_site</code>文件夹内。在命令行中，去到你的站点的根文件夹。在OS X和Linux上:</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># *nix系统</span><br><span class="line">cd ~/workspace/my_site/</span><br><span class="line"></span><br><span class="line">#在Windows上：</span><br><span class="line">cd c:\workspace\my_site</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>我们首先需要告诉git这个文件夹是我们需要跟踪的项目。所以我们发送这个命令来初始化一个新的本地Git代码库</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>Git会在<code>my_site</code>文件夹内创建一个名为<code>.git</code>的隐藏文件夹，那就是你的本地代码库。</li>
</ul>
</blockquote>
<h3 id="加载（Stage）文件"><a href="#加载（Stage）文件" class="headerlink" title="加载（Stage）文件"></a>加载（Stage）文件</h3><blockquote>
<ul>
<li>我们现在需要命令git我们需要加载（stage）所有项目文件。发送：</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>最后的“.”符号的意思是“所有文件、文件夹和子文件夹”。假如我们只想要把特定文件添加到源代码控制中去，我们可以指定它们：</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add my_file, my_other_file</span><br></pre></td></tr></table></figure>


<h3 id="提交文件"><a href="#提交文件" class="headerlink" title="提交文件"></a>提交文件</h3><blockquote>
<p>现在，我们想要提交已加载（staged）的文件。阅读“添加一个时间点，在这里你的文件处在一个可还原的状态”。我们提交我们的文件时，总是附带着有意义的注释，描述了它们现在的状态。我一直用“initial commit”来作为第一个提交的注释。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m &quot;initial commit&quot;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>就这样。现在你随时都可以回滚到这个提交状态。如果你有需要检查你现在的已加载（staged）和未加载（unstaged）文件的状态、提交等，你可以询问git的状态：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure>

<h3 id="推送文件"><a href="#推送文件" class="headerlink" title="推送文件"></a>推送文件</h3><blockquote>
<p>在第一次你想推送一个本地代码库到远程代码库时，你需要把它添加到你的项目配置里。像这样做：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin git@github.com:xxx/yyy.git</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意这里的“origin”只是一个习惯。它是你的远程代码库的别名，但是你可以用其他任何你喜欢的词。你甚至可以有多个远程代码库，你只需要给它们起不同的别名。<br>之后，你想要推送你的本地代码库的主干分支到你的远程代码库：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin master</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/06/11/k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2prometheus%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/11/k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2prometheus%E6%9C%8D%E5%8A%A1/" class="post-title-link" itemprop="url">k8s集群部署prometheus服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-11 22:35:24" itemprop="dateCreated datePublished" datetime="2021-06-11T22:35:24+08:00">2021-06-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-12 00:02:26" itemprop="dateModified" datetime="2021-06-12T00:02:26+08:00">2021-06-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="prometheus介绍"><a href="#prometheus介绍" class="headerlink" title="prometheus介绍"></a>prometheus介绍</h3><blockquote>
<p>Prometheus 是一个开源系统监控和警报工具包，最初构建于 SoundCloud。Prometheus 是Kubernetes之后成为第二个正式加入CNCF基金会的项目。</p>
</blockquote>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="prometheus-ns-yaml"><a href="#prometheus-ns-yaml" class="headerlink" title="prometheus-ns.yaml"></a>prometheus-ns.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-mon</span><br></pre></td></tr></table></figure>

<h4 id="prometheus-rbac-yaml"><a href="#prometheus-rbac-yaml" class="headerlink" title="prometheus-rbac.yaml"></a>prometheus-rbac.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">&quot;&quot;</span></span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/proxy</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">&quot;extensions&quot;</span></span><br><span class="line">  resources:</span><br><span class="line">    - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">&quot;&quot;</span></span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - nodes/metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- nonResourceURLs:</span><br><span class="line">  - /metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: kube-mon</span><br></pre></td></tr></table></figure>

<h4 id="prometheus-cm-yaml"><a href="#prometheus-cm-yaml" class="headerlink" title="prometheus-cm.yaml"></a>prometheus-cm.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-config</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">data:</span><br><span class="line">  prometheus.yml: |</span><br><span class="line">    global:</span><br><span class="line">      scrape_interval: 15s</span><br><span class="line">      scrape_timeout: 15s</span><br><span class="line">    scrape_configs:</span><br><span class="line">    - job_name: <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">      static_configs:</span><br><span class="line">      - targets: [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="prometheus-deploy-yaml"><a href="#prometheus-deploy-yaml" class="headerlink" title="prometheus-deploy.yaml"></a>prometheus-deploy.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      containers:</span><br><span class="line">      - image: prom/prometheus:v2.14.0</span><br><span class="line">        name: prometheus</span><br><span class="line">        args:</span><br><span class="line">        - <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span>  <span class="comment"># 指定tsdb数据路径</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.retention.time=24h&quot;</span></span><br><span class="line">        - <span class="string">&quot;--web.enable-admin-api&quot;</span>  <span class="comment"># 控制对admin HTTP API的访问，其中包括删除时间序列等功能</span></span><br><span class="line">        - <span class="string">&quot;--web.enable-lifecycle&quot;</span>  <span class="comment"># 支持热更新，直接执行localhost:9090/-/reload立即生效</span></span><br><span class="line">        - <span class="string">&quot;--web.console.libraries=/usr/share/prometheus/console_libraries&quot;</span></span><br><span class="line">        - <span class="string">&quot;--web.console.templates=/usr/share/prometheus/consoles&quot;</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          name: http</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: <span class="string">&quot;/etc/prometheus&quot;</span></span><br><span class="line">          name: config-volume</span><br><span class="line">        - mountPath: <span class="string">&quot;/prometheus&quot;</span></span><br><span class="line">          name: data</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 512Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 512Mi</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/prometheus/</span><br><span class="line">      - configMap:</span><br><span class="line">          name: prometheus-config</span><br><span class="line">        name: config-volume</span><br></pre></td></tr></table></figure>
<blockquote>
<p>部署之后发现报错</p>
</blockquote>
<img src="/2021/06/11/k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2prometheus%E6%9C%8D%E5%8A%A1/deploy-error.png" class="" title="部署报错">

<blockquote>
<p>这样的错误信息，这是因为我们的 prometheus 的镜像中是使用的 nobody 这个用户，然后现在我们通过 hostPath 挂载到宿主机上面的目录的 ownership 却是 root</p>
</blockquote>
<h5 id="解决办法（一）"><a href="#解决办法（一）" class="headerlink" title="解决办法（一）"></a>解决办法（一）</h5><blockquote>
<p>这个时候我们就可以通过 securityContext 来为 Pod 设置下 volumes 的权限，通过设置 runAsUser=0 指定运行的用户为 root</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">securityContext:</span><br><span class="line">  runAsUser: 0</span><br></pre></td></tr></table></figure>

<h4 id="prometheus-svc-yaml"><a href="#prometheus-svc-yaml" class="headerlink" title="prometheus-svc.yaml"></a>prometheus-svc.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br><span class="line">  <span class="built_in">type</span>: LoadBalancer <span class="comment">#也可以使用NodePort通过节点IP直接访问</span></span><br><span class="line">  ports:</span><br><span class="line">    - name: web</span><br><span class="line">      port: 9090</span><br><span class="line">      targetPort: http</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考<a target="_blank" rel="noopener" href="https://www.qikqiak.com/k8strain/monitor/prometheus/">Prometheus部署</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/06/11/prometheus-thanos%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/11/prometheus-thanos%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">prometheus+thanos实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-11 18:07:54" itemprop="dateCreated datePublished" datetime="2021-06-11T18:07:54+08:00">2021-06-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-12 12:54:35" itemprop="dateModified" datetime="2021-06-12T12:54:35+08:00">2021-06-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><blockquote>
<p>在以往的prometheus方案中，prometheus基本都是单例部署，如果以多副本的方式部署又会带来数据重复的问题，而且prometheus的数据都是本地磁盘存储，本地磁盘容量总归有上限，如果prometheus的数据量特别大，那么能查询到的监控数据的时间必定很短，在这样的背景下我们不得不寻找更优的解决方案。而thanos的出现解决了上述问题。</p>
</blockquote>
<h2 id="thanos介绍"><a href="#thanos介绍" class="headerlink" title="thanos介绍"></a>thanos介绍</h2><blockquote>
<p>官方的介绍：Open source, highly available Prometheus setup with long term storage capabilities（是一款开源的，为Prometheus提供高可用和长期存储能力的解决方案）</p>
</blockquote>
<h2 id="部署实践"><a href="#部署实践" class="headerlink" title="部署实践"></a>部署实践</h2><h3 id="创建监控服务用的namespace"><a href="#创建监控服务用的namespace" class="headerlink" title="创建监控服务用的namespace"></a>创建监控服务用的namespace</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-mon</span><br></pre></td></tr></table></figure>

<h3 id="prometheus部署"><a href="#prometheus部署" class="headerlink" title="prometheus部署"></a>prometheus部署</h3><h4 id="prometheus-rbac"><a href="#prometheus-rbac" class="headerlink" title="prometheus-rbac"></a>prometheus-rbac</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus权限设置</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">&quot;&quot;</span></span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  - nodes/proxy</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">&quot;extensions&quot;</span></span><br><span class="line">  resources:</span><br><span class="line">    - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">&quot;&quot;</span></span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - nodes/metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- nonResourceURLs:</span><br><span class="line">  - /metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- nonResourceURLs:</span><br><span class="line">  - /metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: kube-mon</span><br></pre></td></tr></table></figure>

<h4 id="prometheus-config"><a href="#prometheus-config" class="headerlink" title="prometheus-config"></a>prometheus-config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-config</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">data:</span><br><span class="line">  prometheus.yaml.tmpl: |-</span><br><span class="line">    global:</span><br><span class="line">      scrape_interval: 5s</span><br><span class="line">      evaluation_interval: 5s</span><br><span class="line">      external_labels:</span><br><span class="line">        cluster: prometheus-ha</span><br><span class="line">        <span class="comment"># Each Prometheus has to have unique labels.</span></span><br><span class="line">        replica: $(POD_NAME)</span><br><span class="line">    rule_files:</span><br><span class="line">      - /etc/prometheus/rules/*rules.yaml</span><br><span class="line">    alerting:</span><br><span class="line">      <span class="comment"># We want our alerts to be deduplicated</span></span><br><span class="line">      <span class="comment"># from different replicas.</span></span><br><span class="line">      alert_relabel_configs:</span><br><span class="line">      - regex: replica</span><br><span class="line">        action: labeldrop</span><br><span class="line">      alertmanagers:</span><br><span class="line">        - scheme: http</span><br><span class="line">          path_prefix: /</span><br><span class="line">          static_configs:</span><br><span class="line">            - targets: [<span class="string">&#x27;alertmanager:9093&#x27;</span>]</span><br><span class="line">    scrape_configs:</span><br><span class="line">    - job_name: kubernetes-nodes-cadvisor</span><br><span class="line">      scrape_interval: 10s</span><br><span class="line">      scrape_timeout: 10s</span><br><span class="line">      scheme: https</span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: pod</span><br><span class="line">      relabel_configs:</span><br><span class="line">        - action: labelmap</span><br><span class="line">          regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">        - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: kubernetes_namespace</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: kubernetes_pod_name</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: <span class="literal">true</span></span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __scheme__</span><br><span class="line">          regex: (https?)</span><br><span class="line">        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __metrics_path__</span><br><span class="line">          regex: (.+)</span><br><span class="line">        - source_labels: [__address__, __meta_kubernetes_pod_prometheus_io_port]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __address__</span><br><span class="line">          regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">          replacement: <span class="variable">$1</span>:<span class="variable">$2</span>​</span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-apiservers&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: endpoints</span><br><span class="line">      scheme: https </span><br><span class="line">      tls_config:</span><br><span class="line">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">      relabel_configs:</span><br><span class="line">        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: default;kubernetes;https</span><br><span class="line">    - job_name: <span class="string">&#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line">      kubernetes_sd_configs:</span><br><span class="line">        - role: endpoints</span><br><span class="line">      relabel_configs:</span><br><span class="line">        - action: labelmap</span><br><span class="line">          regex: __meta_kubernetes_service_label_(.+)</span><br><span class="line">        - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: kubernetes_namespace</span><br><span class="line">        - source_labels: [__meta_kubernetes_service_name]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: kubernetes_name</span><br><span class="line">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span><br><span class="line">          action: keep</span><br><span class="line">          regex: <span class="literal">true</span></span><br><span class="line">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __scheme__</span><br><span class="line">          regex: (https?)</span><br><span class="line">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __metrics_path__</span><br><span class="line">          regex: (.+)</span><br><span class="line">        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class="line">          action: replace</span><br><span class="line">          target_label: __address__</span><br><span class="line">          regex: (.+)(?::\d+);(\d+)</span><br><span class="line">          replacement: <span class="variable">$1</span>:<span class="variable">$2</span></span><br></pre></td></tr></table></figure>

<h4 id="prometheus-rules-yaml"><a href="#prometheus-rules-yaml" class="headerlink" title="prometheus-rules.yaml"></a>prometheus-rules.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-rules</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">data:</span><br><span class="line">  alert-rules.yaml: |-</span><br><span class="line">    groups:</span><br><span class="line">      - name: Deployment</span><br><span class="line">        rules:</span><br><span class="line">        - alert: Deployment at 0 Replicas</span><br><span class="line">          annotations:</span><br><span class="line">            summary: Deployment &#123;&#123;<span class="variable">$labels</span>.deployment&#125;&#125; <span class="keyword">in</span> &#123;&#123;<span class="variable">$labels</span>.namespace&#125;&#125; is currently having no pods running</span><br><span class="line">          expr: |</span><br><span class="line">            sum(kube_deployment_status_replicas) by (deployment,namespace)  &lt; 1</span><br><span class="line">          <span class="keyword">for</span>: 1m</span><br><span class="line">          labels:</span><br><span class="line">            team: node</span><br><span class="line">      - name: Pods</span><br><span class="line">        rules:</span><br><span class="line">        - alert: Container restarted</span><br><span class="line">          annotations:</span><br><span class="line">            summary: Container named &#123;&#123;<span class="variable">$labels</span>.container&#125;&#125; <span class="keyword">in</span> &#123;&#123;<span class="variable">$labels</span>.pod&#125;&#125; <span class="keyword">in</span> &#123;&#123;<span class="variable">$labels</span>.namespace&#125;&#125; was restarted</span><br><span class="line">          expr: |</span><br><span class="line">            sum(increase(kube_pod_container_status_restarts_total[1m])) by (pod,namespace,container) &gt; 0</span><br><span class="line">          <span class="keyword">for</span>: 0m</span><br><span class="line">          labels:</span><br><span class="line">            team: node</span><br></pre></td></tr></table></figure>

<h4 id="prometheus-sts"><a href="#prometheus-sts" class="headerlink" title="prometheus-sts"></a>prometheus-sts</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">spec:</span><br><span class="line">  serviceName: <span class="string">&quot;prometheus&quot;</span></span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">      thanos-store-api: <span class="string">&quot;true&quot;</span></span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: prometheus</span><br><span class="line">        thanos-store-api: <span class="string">&quot;true&quot;</span></span><br><span class="line">    spec:</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      volumes:</span><br><span class="line">      - name: prometheus-config</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-config</span><br><span class="line">      - name: prometheus-rules</span><br><span class="line">        configMap:</span><br><span class="line">          name: prometheus-rules</span><br><span class="line">      - name: prometheus-config-shared</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      containers:</span><br><span class="line">      - name: prometheus</span><br><span class="line">        image: prom/prometheus:v2.14.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - <span class="string">&quot;--config.file=/etc/prometheus-shared/prometheus.yaml&quot;</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.retention.time=6h&quot;</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.no-lockfile&quot;</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.min-block-duration=2h&quot;</span>  <span class="comment"># Thanos处理数据压缩</span></span><br><span class="line">        - <span class="string">&quot;--storage.tsdb.max-block-duration=2h&quot;</span></span><br><span class="line">        - <span class="string">&quot;--web.enable-admin-api&quot;</span>  <span class="comment"># 通过一些命令去管理数据</span></span><br><span class="line">        - <span class="string">&quot;--web.enable-lifecycle&quot;</span>  <span class="comment"># 支持热更新  localhost:9090/-/reload 加载</span></span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 9090</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line">          limits:</span><br><span class="line">            memory: <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: prometheus-config-shared</span><br><span class="line">          mountPath: /etc/prometheus-shared/</span><br><span class="line">        - name: prometheus-rules</span><br><span class="line">          mountPath: /etc/prometheus/rules</span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: <span class="string">&quot;/prometheus&quot;</span></span><br><span class="line">      - name: thanos</span><br><span class="line">        image: thanosio/thanos:v0.11.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        args:</span><br><span class="line">        - sidecar</span><br><span class="line">        - --log.level=debug</span><br><span class="line">        - --tsdb.path=/prometheus</span><br><span class="line">        - --prometheus.url=http://localhost:9090</span><br><span class="line">        - --reloader.config-file=/etc/prometheus/prometheus.yaml.tmpl</span><br><span class="line">        - --reloader.config-envsubst-file=/etc/prometheus-shared/prometheus.yaml</span><br><span class="line">        - --reloader.rule-dir=/etc/prometheus/rules/</span><br><span class="line">        ports:</span><br><span class="line">        - name: http-sidecar</span><br><span class="line">          containerPort: 10902</span><br><span class="line">        - name: grpc</span><br><span class="line">          containerPort: 10901</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line">          limits:</span><br><span class="line">            memory: <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            cpu: <span class="string">&quot;2&quot;</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: prometheus-config-shared</span><br><span class="line">          mountPath: /etc/prometheus-shared/</span><br><span class="line">        - name: prometheus-config</span><br><span class="line">          mountPath: /etc/prometheus</span><br><span class="line">        - name: prometheus-rules</span><br><span class="line">          mountPath: /etc/prometheus/rules</span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: <span class="string">&quot;/prometheus&quot;</span></span><br><span class="line">  volumeClaimTemplates:  <span class="comment"># 由于prometheus每2h生成一个TSDB数据块，所以还是需要保存本地的数据</span></span><br><span class="line">  - metadata:</span><br><span class="line">      name: data</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus</span><br><span class="line">    spec:</span><br><span class="line">      storageClassName: ssd-csi-udisk <span class="comment">#csi-ufile</span></span><br><span class="line">      accessModes:</span><br><span class="line">      - ReadWriteOnce</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 10Gi</span><br></pre></td></tr></table></figure>

<h4 id="prometheus-svc"><a href="#prometheus-svc" class="headerlink" title="prometheus-svc"></a>prometheus-svc</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br><span class="line">  <span class="built_in">type</span>: LoadBalancer</span><br><span class="line">  ports:</span><br><span class="line">    - name: web</span><br><span class="line">      port: 9090</span><br><span class="line">      targetPort: http</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查询结果如下：</p>
</blockquote>
<img src="/2021/06/11/prometheus-thanos%E5%AE%9E%E8%B7%B5/prometheus-sts.png" class="" title="查询结果随机从一个实例中取">

<h4 id="headless"><a href="#headless" class="headerlink" title="headless"></a>headless</h4><blockquote>
<p>无头 Service 并不会分配 Cluster IP，kube-proxy 不会处理它们， 而且平台也不会为它们进行负载均衡和路由。 DNS 如何实现自动配置，依赖于 Service 是否定义了选择算符。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该服务为查 querier 创建 srv 记录，以便查找 store-api 的信息</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: thanos-store-gateway</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: grpc</span><br><span class="line">    port: 10901</span><br><span class="line">    targetPort: grpc</span><br><span class="line">  selector:</span><br><span class="line">    thanos-store-api: <span class="string">&quot;true&quot;</span> <span class="comment">#匹配sts的pod，自动注册到dns中</span></span><br></pre></td></tr></table></figure>

<h3 id="thanos部署"><a href="#thanos部署" class="headerlink" title="thanos部署"></a>thanos部署</h3><h4 id="thanos-querier-yaml"><a href="#thanos-querier-yaml" class="headerlink" title="thanos-querier.yaml"></a>thanos-querier.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># querier通过thanos-store-gateway去获取prometheus的数据</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: thanos-querier</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">  labels:</span><br><span class="line">    app: thanos-querier</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: thanos-querier</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: thanos-querier</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: thanos</span><br><span class="line">        image: thanosio/thanos:v0.11.0</span><br><span class="line">        args:</span><br><span class="line">        - query</span><br><span class="line">        - --log.level=debug</span><br><span class="line">        - --query.replica-label=replica</span><br><span class="line">        <span class="comment"># Discover local store APIs using DNS SRV.</span></span><br><span class="line">        - --store=dnssrv+thanos-store-gateway:10901</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 10902</span><br><span class="line">        - name: grpc</span><br><span class="line">          containerPort: 10901</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line">          limits:</span><br><span class="line">            memory: <span class="string">&quot;2Gi&quot;</span></span><br><span class="line">            cpu: <span class="string">&quot;1&quot;</span></span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /-/healthy</span><br><span class="line">            port: http</span><br><span class="line">          initialDelaySeconds: 10</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /-/healthy</span><br><span class="line">            port: http</span><br><span class="line">          initialDelaySeconds: 15</span><br></pre></td></tr></table></figure>

<h4 id="svc"><a href="#svc" class="headerlink" title="svc"></a>svc</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: thanos-querier</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">  labels:</span><br><span class="line">    app: thanos-querier</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: http</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: thanos-querier</span><br><span class="line">  <span class="built_in">type</span>: LoadBalancer</span><br></pre></td></tr></table></figure>

<blockquote>
<p>未去重结果</p>
</blockquote>
<img src="/2021/06/11/prometheus-thanos%E5%AE%9E%E8%B7%B5/thanos-dup.png" class="" title="未去重的结果">

<blockquote>
<p>去重结果</p>
</blockquote>
<img src="/2021/06/11/prometheus-thanos%E5%AE%9E%E8%B7%B5/thanos-dedup.png" class="" title="去重的结果">


<h3 id="Store-组件"><a href="#Store-组件" class="headerlink" title="Store 组件"></a>Store 组件</h3><blockquote>
<p>Thanos now supported GCS, S3, Azure, Swift, Tencent COS and Aliyun OSS.所以对于一些暂时没有接入到官方库的对象存储产品，需要一个中转的服务：minio</p>
</blockquote>
<h4 id="minio"><a href="#minio" class="headerlink" title="minio"></a>minio</h4><blockquote>
<p>MinIO’s high performance, Kubernetes-native object storage suite is<br>built for the demands of the hybrid cloud. Software-defined, it delivers<br>a consistent experience across every Kubernetes environment.(minio是一个云原生的对象存储服务)</p>
</blockquote>
<h3 id="部署minio"><a href="#部署minio" class="headerlink" title="部署minio"></a>部署minio</h3><h4 id="mini-namespace-yaml"><a href="#mini-namespace-yaml" class="headerlink" title="mini-namespace.yaml"></a>mini-namespace.yaml</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: minio</span><br></pre></td></tr></table></figure>

<h4 id="minio-deploy-yaml"><a href="#minio-deploy-yaml" class="headerlink" title="minio-deploy.yaml"></a>minio-deploy.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: minio</span><br><span class="line">  namespace: minio</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: minio </span><br><span class="line">  strategy:</span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: minio</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: minio-pvc</span><br><span class="line">      containers:</span><br><span class="line">      - name: minio</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: data </span><br><span class="line">          mountPath: /data</span><br><span class="line">        image: minio/minio:RELEASE.2021-05-27T22-06-31Z</span><br><span class="line">        args:</span><br><span class="line">        - server</span><br><span class="line">        - /data</span><br><span class="line">        env:</span><br><span class="line">        - name: MINIO_ACCESS_KEY</span><br><span class="line">          value: <span class="string">&quot;minio&quot;</span></span><br><span class="line">        - name: MINIO_SECRET_KEY</span><br><span class="line">          value: <span class="string">&quot;minio123&quot;</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /minio/health/ready</span><br><span class="line">            port: 9000</span><br><span class="line">          initialDelaySeconds: 90</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /minio/health/live</span><br><span class="line">            port: 9000</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 10</span><br></pre></td></tr></table></figure>

<h4 id="minio-pvc-yaml"><a href="#minio-pvc-yaml" class="headerlink" title="minio-pvc.yaml"></a>minio-pvc.yaml</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.ucloud.cn/uk8s/volume/ufile">在UK8S中使用US3</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: us3-secret</span><br><span class="line">  namespace: kube-system</span><br><span class="line">stringData:</span><br><span class="line">  accessKeyID: TOKEN_9a6ec9fd-9cb7-4510-8ded-xxxxxxxx <span class="comment"># 非账号公钥，为US3的令牌公钥。</span></span><br><span class="line">  secretAccessKey: c429c8e5-e4e6-4366-bf93-xxxxxx <span class="comment"># 非账号私钥，为US3的令牌私钥。</span></span><br><span class="line">  endpoint: http://internal.s3-cn-bj.ufileos.com</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: csi-ufile</span><br><span class="line">provisioner: ufile.csi.ucloud.cn</span><br><span class="line">parameters:</span><br><span class="line">  bucket: s3-bucketname  <span class="comment"># 事先申请好的US3 Bucket</span></span><br><span class="line">  csi.storage.k8s.io/node-publish-secret-name: csi-s3-secret <span class="comment"># 关联前一步创建的Secret</span></span><br><span class="line">  csi.storage.k8s.io/node-publish-secret-namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: minio-pvc</span><br><span class="line">  namespace: minio</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: csi-ufile</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 50Gi</span><br></pre></td></tr></table></figure>

<h4 id="minio-svc-yaml"><a href="#minio-svc-yaml" class="headerlink" title="minio-svc.yaml"></a>minio-svc.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: minio</span><br><span class="line">  namespace: minio</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: LoadBalancer</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9000</span><br><span class="line">    targetPort: 9000</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: minio</span><br></pre></td></tr></table></figure>

<h3 id="关联thanos和minio"><a href="#关联thanos和minio" class="headerlink" title="关联thanos和minio"></a>关联thanos和minio</h3><h4 id="thanos-storage-minio-yaml"><a href="#thanos-storage-minio-yaml" class="headerlink" title="thanos-storage-minio.yaml"></a>thanos-storage-minio.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: thanos-objectstorage</span><br><span class="line">  namespace: kube-mon</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">stringData:</span><br><span class="line">  thanos.yaml: |-</span><br><span class="line">    <span class="built_in">type</span>: s3</span><br><span class="line">    config:</span><br><span class="line">     bucket: prometheus</span><br><span class="line">     endpoint: minio.minio.svc.cluster.local:9000</span><br><span class="line">     access_key: minio</span><br><span class="line">     insecure: <span class="literal">true</span></span><br><span class="line">     secret_key: minio123</span><br></pre></td></tr></table></figure>

<h4 id="store-yaml"><a href="#store-yaml" class="headerlink" title="store.yaml"></a>store.yaml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: thanos-store-gateway</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">  labels:</span><br><span class="line">    app: thanos-store-gateway</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: thanos-store-gateway</span><br><span class="line">  serviceName: thanos-store-gateway</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: thanos-store-gateway</span><br><span class="line">        thanos-store-api: <span class="string">&quot;true&quot;</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: thanos</span><br><span class="line">          image: thanosio/thanos:v0.21.0</span><br><span class="line">          args:</span><br><span class="line">          - <span class="string">&quot;store&quot;</span></span><br><span class="line">          - <span class="string">&quot;--log.level=debug&quot;</span></span><br><span class="line">          - <span class="string">&quot;--data-dir=/data&quot;</span></span><br><span class="line">          - <span class="string">&quot;--objstore.config-file=/etc/secret/thanos.yaml&quot;</span></span><br><span class="line">          - <span class="string">&quot;--index-cache-size=500MB&quot;</span></span><br><span class="line">          - <span class="string">&quot;--chunk-pool-size=500MB&quot;</span></span><br><span class="line">          ports:</span><br><span class="line">          - name: http</span><br><span class="line">            containerPort: 10902</span><br><span class="line">          - name: grpc</span><br><span class="line">            containerPort: 10901</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              port: 10902</span><br><span class="line">              path: /-/healthy</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              port: 10902</span><br><span class="line">              path: /-/ready</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: object-storage-config</span><br><span class="line">              mountPath: /etc/secret</span><br><span class="line">              readOnly: <span class="literal">false</span></span><br><span class="line">      volumes:</span><br><span class="line">        - name: object-storage-config</span><br><span class="line">          secret:</span><br><span class="line">            secretName: thanos-objectstorage</span><br></pre></td></tr></table></figure>

<h4 id="修改sidecar的配置"><a href="#修改sidecar的配置" class="headerlink" title="修改sidecar的配置"></a>修改sidecar的配置</h4><blockquote>
<p>我们需要把 objstore.config-file 参数和 Secret 对象也要配置到 Sidecar 组件中去。<code>volumes</code> <code>args</code> <code>volumeMounts</code>分别加上以下配置</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">volumes:</span><br><span class="line">- name: object-storage-config</span><br><span class="line">  secret:</span><br><span class="line">    secretName: thanos-objectstorage</span><br><span class="line">......</span><br><span class="line">args:</span><br><span class="line">...</span><br><span class="line">- --reloader.rule-dir=/etc/prometheus/rules/</span><br><span class="line">- --objstore.config-file=/etc/secret/thanos.yaml #添加该行</span><br><span class="line">......</span><br><span class="line">volumeMounts:</span><br><span class="line">- name: object-storage-config</span><br><span class="line">  mountPath: /etc/secret</span><br><span class="line">  readOnly: false</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置生效过后正常的话就会有数据传入到 MinIO 里面去了，我们可以去 MinIO 的页面上查看验证</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.qikqiak.com/k8strain/monitor/thanos/">参考thanos</a></p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h4 id="node-export"><a href="#node-export" class="headerlink" title="node-export"></a>node-export</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">piVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: kube-mon</span><br><span class="line">  labels:</span><br><span class="line">    app: node-exporter</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: node-exporter</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: node-exporter</span><br><span class="line">    spec:</span><br><span class="line">      hostPID: <span class="literal">true</span></span><br><span class="line">      hostIPC: <span class="literal">true</span></span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      containers:</span><br><span class="line">      - name: node-exporter</span><br><span class="line">        image: prom/node-exporter:v0.18.1</span><br><span class="line">        args:</span><br><span class="line">        - --web.listen-address=$(HOSTIP):9100</span><br><span class="line">        - --path.procfs=/host/proc</span><br><span class="line">        - --path.sysfs=/host/sys</span><br><span class="line">        - --path.rootfs=/host/root</span><br><span class="line">        - --collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/docker/.+)($|/)</span><br><span class="line">        - --collector.filesystem.ignored-fs-types=^(autofs|binfmt_misc|cgroup|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|mqueue|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|sysfs|tracefs)$</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9100</span><br><span class="line">        env:</span><br><span class="line">        - name: HOSTIP</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: status.hostIP</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 150m</span><br><span class="line">            memory: 180Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 150m</span><br><span class="line">            memory: 180Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          runAsNonRoot: <span class="literal">true</span></span><br><span class="line">          runAsUser: 65534</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: proc</span><br><span class="line">          mountPath: /host/proc</span><br><span class="line">        - name: sys</span><br><span class="line">          mountPath: /host/sys</span><br><span class="line">        - name: root</span><br><span class="line">          mountPath: /host/root</span><br><span class="line">          mountPropagation: HostToContainer</span><br><span class="line">          readOnly: <span class="literal">true</span></span><br><span class="line">      tolerations:</span><br><span class="line">      - operator: <span class="string">&quot;Exists&quot;</span></span><br><span class="line">      volumes:</span><br><span class="line">      - name: proc</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /proc</span><br><span class="line">      - name: dev</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /dev</span><br><span class="line">      - name: sys</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /sys</span><br><span class="line">      - name: root</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/06/04/%E5%AE%89%E8%A3%85docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/04/%E5%AE%89%E8%A3%85docker/" class="post-title-link" itemprop="url">安装docker</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-06-04 18:51:25 / 修改时间：20:12:10" itemprop="dateCreated datePublished" datetime="2021-06-04T18:51:25+08:00">2021-06-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="ubuntu环境"><a href="#ubuntu环境" class="headerlink" title="ubuntu环境"></a>ubuntu环境</h3><h4 id="最新版本"><a href="#最新版本" class="headerlink" title="最新版本"></a>最新版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line"></span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg-agent \</span><br><span class="line">    software-properties-common</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">//Add Docker’s official GPG key</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line">//Verify that you now have the key with the fingerprint</span><br><span class="line">apt-key fingerprint 0EBFCD88</span><br><span class="line"></span><br><span class="line">//amd64</span><br><span class="line">sudo add-apt-repository \</span><br><span class="line">   <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">   <span class="subst">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">   stable&quot;</span></span><br><span class="line">   </span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<h4 id="指定版本"><a href="#指定版本" class="headerlink" title="指定版本"></a>指定版本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//List the versions available <span class="keyword">in</span> your repo</span><br><span class="line">apt-cache madison docker-ce</span><br><span class="line"></span><br><span class="line">//Install a specific version</span><br><span class="line">sudo apt-get install docker-ce=&lt;VERSION_STRING&gt; docker-ce-cli=&lt;VERSION_STRING&gt; containerd.io</span><br></pre></td></tr></table></figure>

<h3 id="centos环境"><a href="#centos环境" class="headerlink" title="centos环境"></a>centos环境</h3><h4 id="rpm包安装——方式一"><a href="#rpm包安装——方式一" class="headerlink" title="rpm包安装——方式一"></a>rpm包安装——方式一</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载docker-ce包</span></span><br><span class="line">wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-18.09.2-3.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-ce-cli包</span></span><br><span class="line">wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-cli-18.09.2-3.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># containerd.io包</span></span><br><span class="line">wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.2-3.3.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">### 安装rpm包（注意顺序）</span></span><br><span class="line">yum install docker-ce-cli-18.09.2-3.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">yum install containerd.io-1.2.2-3.3.el7.x86_64.rpm</span><br><span class="line">yum install docker-ce-18.09.2-3.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.docker.com/install/linux/docker-ce/centos/">【参考】https://docs.docker.com/install/linux/docker-ce/centos/</a><br><a target="_blank" rel="noopener" href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/">【rpm包地址】https://download.docker.com/linux/centos/7/x86_64/stable/Packages/</a></p>
<h4 id="rpm包安装——方式二"><a href="#rpm包安装——方式二" class="headerlink" title="rpm包安装——方式二"></a>rpm包安装——方式二</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/xxx.rpm</span><br><span class="line"></span><br><span class="line">sudo yum install /path/to/package.rpm</span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>

<h5 id="卸载docker"><a href="#卸载docker" class="headerlink" title="卸载docker"></a>卸载docker</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker-ce</span><br><span class="line">sudo rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure>

<h4 id="yum安装"><a href="#yum安装" class="headerlink" title="yum安装"></a>yum安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager   --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">sudo yum makecache fast</span><br><span class="line">sudo yum install docker-ce</span><br><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/installation/linux/centos/#install-using-the-repository">【参考】https://docs.docker.com/engine/installation/linux/centos/#install-using-the-repository</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/06/04/Dockerfile-%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/04/Dockerfile-%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">Dockerfile 指令详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-06-04 17:50:03 / 修改时间：17:55:36" itemprop="dateCreated datePublished" datetime="2021-06-04T17:50:03+08:00">2021-06-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="COPY-复制文件"><a href="#COPY-复制文件" class="headerlink" title="COPY 复制文件"></a>COPY 复制文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">COPY &lt;源路径&gt;... &lt;目标路径&gt;</span><br><span class="line">COPY [<span class="string">&quot;&lt;源路径1&gt;&quot;</span>,... <span class="string">&quot;&lt;目标路径&gt;&quot;</span>]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>和 RUN 指令一样，也有两种格式，一种类似于命令行，一种类似于函数调用。<br>COPY 指令将从构建上下文目录中 &lt;源路径&gt; 的文件/目录复制到新的一层的镜像内的 &lt;目标路径&gt; 位置。比如：<br>COPY package.json /usr/src/app/</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>&lt;源路径&gt; 可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 filepath.Match 规则，如：<br>COPY hom* /mydir/<br>COPY hom?.txt /mydir/</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>&lt;目标路径&gt; 可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 WORKDIR指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>此外，还需要注意一点，使用COPY指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候.</li>
</ul>
</blockquote>
<h3 id="ADD-更高级的复制文件"><a href="#ADD-更高级的复制文件" class="headerlink" title="ADD 更高级的复制文件"></a>ADD 更高级的复制文件</h3><blockquote>
<p>ADD 指令和 COPY 的格式和性质基本一致。但是在 COPY 基础上增加了一些功能。</p>
</blockquote>
<h4 id="源路径可以是URL"><a href="#源路径可以是URL" class="headerlink" title="源路径可以是URL"></a>源路径可以是URL</h4><blockquote>
<p>比如 &lt;源路径&gt; 可以是一个 URL，这种情况下，Docker 引擎会试图去下载这个链接的文件放到 &lt;目标路径&gt; 去。下载后的文件权限自动设置为 600，如果这并不是想要的权限，那么还需要增加额外的一层 RUN进行权限调整</p>
</blockquote>
<h4 id="源文件可以是压缩包"><a href="#源文件可以是压缩包" class="headerlink" title="源文件可以是压缩包"></a>源文件可以是压缩包</h4><blockquote>
<p>另外，如果下载的是个压缩包，需要解压缩，也一样还需要额外的一层 RUN 指令进行解压缩。所以不如直接使用 RUN 指令，然后使用 wget 或者 curl工具下载，处理权限、解压缩、然后清理无用文件更合理。因此，这个功能其实并不实用，而且<code>不推荐使用</code>。<br>如果 &lt;源路径&gt; 为一个 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，ADD 指令将会自动解压缩这个压缩文件到 &lt;目标路径&gt; 去。<br>在某些情况下，这个自动解压缩的功能非常有用，比如官方镜像 ubuntu 中：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch</span><br><span class="line">ADD ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="COPY和ADD适用场景说明"><a href="#COPY和ADD适用场景说明" class="headerlink" title="COPY和ADD适用场景说明"></a>COPY和ADD适用场景说明</h4><blockquote>
<ul>
<li>在 Docker 官方的最佳实践文档中要求，尽可能的使用 COPY，因为 COPY 的语义很明确，就是复制文件而已，而 ADD 则包含了更复杂的功能，其行为也不一定很清晰。最适合使用 ADD 的场合，就是所提及的需要自动解压缩的场合。</li>
<li>另外需要注意的是，ADD 指令会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。<br>因此在 COPY 和 ADD 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 COPY 指令，仅在需要自动解压缩的场合使用 ADD。</li>
</ul>
</blockquote>
<h3 id="CMD-容器启动命令"><a href="#CMD-容器启动命令" class="headerlink" title="CMD 容器启动命令"></a>CMD 容器启动命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell 格式：CMD &lt;命令&gt;</span><br><span class="line"><span class="built_in">exec</span> 格式：CMD [<span class="string">&quot;可执行文件&quot;</span>, <span class="string">&quot;参数1&quot;</span>, <span class="string">&quot;参数2&quot;</span>...]</span><br><span class="line">参数列表格式：CMD [<span class="string">&quot;参数1&quot;</span>, <span class="string">&quot;参数2&quot;</span>...]。在指定了 ENTRYPOINT 指令后，用 CMD 指定具体的参数。</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>Docker 不是虚拟机，容器就是进程。既然是进程，那么在启动容器的时候，需要指定所运行的程序及参数。CMD 指令就是用于指定默认的容器主进程的启动命令的。</li>
<li>在运行时可以指定新的命令来替代镜像设置中的这个默认命令，比如，ubuntu 镜像默认的 CMD 是<code>/bin/bash</code>，如果我们直接 <code>docker run -it ubuntu</code> 的话，会直接进入bash。我们也可以在运行时指定运行别的命令，如 <code>docker run -it ubuntu cat /etc/os-release</code>。这就是用 <code>cat /etc/os-release</code> 命令替换了默认的 <code>/bin/bash</code> 命令了，输出了系统版本信息。</li>
<li>在指令格式上，一般推荐使用 <code>exec</code> 格式，这类格式在解析时会被解析为 JSON 数组，因此一定要使用双引号 “，而不要使用单引号。</li>
<li>如果使用 shell 格式的话，实际的命令会被包装为 sh -c 的参数的形式进行执行。比如：<code>CMD echo $HOME</code>在实际执行中，会将其变更为：<code>CMD [ &quot;sh&quot;, &quot;-c&quot;, &quot;echo $HOME&quot; ]</code></li>
<li>这就是为什么我们可以使用环境变量的原因，因为这些环境变量会被 shell 进行解析处理。<br>提到 CMD 就不得不提容器中应用在前台执行和后台执行的问题。这是初学者常出现的一个混淆。</li>
<li>Docker 不是虚拟机，容器中的应用都应该以前台执行，而不是像虚拟机、物理机里面那样，用 upstart/systemd 去启动后台服务，容器内没有后台服务的概念。一些初学者将 CMD 写为：<code>CMD service nginx start</code></li>
<li>然后发现容器执行后就立即退出了。甚至在容器内去使用systemctl命令结果却发现根本执行不了。这就是因为没有搞明白前台、后台的概念，没有区分容器和虚拟机的差异，依旧在以传统虚拟机的角度去理解容器。</li>
<li>对于容器而言，其启动程序就是容器应用进程，容器就是为了主进程而存在的，主进程退出，容器就失去了存在的意义，从而退出，其它辅助进程不是它需要关心的东西。</li>
<li>而使用 service nginx start 命令，则是希望 upstart 来以后台守护进程形式启动 nginx 服务。而刚才说了 CMD service nginx start 会被理解为 CMD [ “sh”, “-c”, “service nginx start”]，因此主进程实际上是 sh。那么当 service nginx start 命令结束后，sh 也就结束了，sh 作为主进程退出了，自然就会令容器退出。</li>
<li>正确的做法是直接执行 nginx 可执行文件，并且要求以前台形式运行。比如：CMD [“nginx”, “-g”, “daemon off;”]</li>
</ul>
</blockquote>
<h4 id="ENTRYPOINT-入口点"><a href="#ENTRYPOINT-入口点" class="headerlink" title="ENTRYPOINT 入口点"></a>ENTRYPOINT 入口点</h4><blockquote>
<p>让镜像变成像命令一样使用;应用运行前的准备工作</p>
</blockquote>
<h3 id="ENV-设置环境变量"><a href="#ENV-设置环境变量" class="headerlink" title="ENV 设置环境变量"></a>ENV 设置环境变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ENV &lt;key&gt; &lt;value&gt;</span><br><span class="line">ENV &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt;...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个指令很简单，就是设置环境变量而已，无论是后面的其它指令，如RUN，还是运行时的应用，都可以直接使用这里定义的环境变量。</p>
</blockquote>
<h3 id="ARG-构建参数"><a href="#ARG-构建参数" class="headerlink" title="ARG 构建参数"></a>ARG 构建参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARG &lt;参数名&gt;[=&lt;默认值&gt;]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>构建参数和 ENV 的效果一样，都是设置环境变量。所不同的是，ARG所设置的构建环境的环境变量，在将来容器运行时是不会存在这些环境变量的。但是不要因此就使用 ARG 保存密码之类的信息，因为 docker history 还是可以看到所有值的。</p>
</blockquote>
<h3 id="VOLUME-定义匿名卷"><a href="#VOLUME-定义匿名卷" class="headerlink" title="VOLUME 定义匿名卷"></a>VOLUME 定义匿名卷</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VOLUME [<span class="string">&quot;&lt;路径1&gt;&quot;</span>, <span class="string">&quot;&lt;路径2&gt;&quot;</span>...]</span><br><span class="line">VOLUME &lt;路径&gt;</span><br></pre></td></tr></table></figure>

<h3 id="EXPOSE-声明端口"><a href="#EXPOSE-声明端口" class="headerlink" title="EXPOSE 声明端口"></a>EXPOSE 声明端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE &lt;端口1&gt; [&lt;端口2&gt;...]。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>EXPOSE 指令是声明运行时容器提供服务端口，这只是一个声明，在运行时并不会因为这个声明应用就会开启这个端口的服务。</p>
</blockquote>
<h3 id="WORKDIR-指定工作目录"><a href="#WORKDIR-指定工作目录" class="headerlink" title="WORKDIR 指定工作目录"></a>WORKDIR 指定工作目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR &lt;工作目录路径&gt;。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 WORKDIR 指令可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，WORKDIR 会帮你建立目录。</p>
</blockquote>
<h3 id="USER-指定当前用户"><a href="#USER-指定当前用户" class="headerlink" title="USER 指定当前用户"></a>USER 指定当前用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USER &lt;用户名&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>USER 指令和 WORKDIR 相似，都是改变环境状态并影响以后的层。WORKDIR是改变工作目录，USER则是改变之后层的执行 RUN, CMD 以及 ENTRYPOINT 这类命令的身份。</p>
</blockquote>
<h3 id="HEALTHCHECK-健康检查"><a href="#HEALTHCHECK-健康检查" class="headerlink" title="HEALTHCHECK 健康检查"></a>HEALTHCHECK 健康检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HEALTHCHECK [选项] CMD &lt;命令&gt;：设置检查容器健康状况的命令</span><br><span class="line">HEALTHCHECK NONE：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令</span><br></pre></td></tr></table></figure>

<h3 id="ONBUILD-为他人做嫁衣裳"><a href="#ONBUILD-为他人做嫁衣裳" class="headerlink" title="ONBUILD 为他人做嫁衣裳"></a>ONBUILD 为他人做嫁衣裳</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ONBUILD &lt;其它指令&gt;。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ONBUILD 是一个特殊的指令，它后面跟的是其它指令，比如 RUN, COPY等，而这些指令，在当前镜像构建时并不会被执行。只有当以当前镜像为基础镜像，去构建下一级镜像的时候才会被执行。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/06/04/%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/04/%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/" class="post-title-link" itemprop="url">容器镜像修改时区</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-06-04 17:19:10 / 修改时间：17:21:33" itemprop="dateCreated datePublished" datetime="2021-06-04T17:19:10+08:00">2021-06-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><blockquote>
<p>在Kubernetes集群中运行的容器默认会使用UTC时间，即pod内0点时刻，北京时间为上午8点。所以对于一些有时区要求的场景就变得非常不方便。</p>
</blockquote>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><blockquote>
<p>我们可以修改容器镜像的时区来规避因为时区不一致带来的问题</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:18.04</span><br><span class="line">RUN apt-get install tzdata -y</span><br><span class="line">RUN rm -f /etc/localtime \</span><br><span class="line">&amp;&amp; ln -sv /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span><br><span class="line">&amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;Asia/Shanghai&quot;</span> &gt; /etc/timezone</span><br></pre></td></tr></table></figure>

<img src="/2021/06/04/%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/utc-time.jpg" class="" title="utc时间">
<img src="/2021/06/04/%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/beijing-time.jpg" class="" title="北京时间">
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/06/04/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/04/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-04 16:21:35" itemprop="dateCreated datePublished" datetime="2021-06-04T16:21:35+08:00">2021-06-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://onepiecelover.github.io/2021/05/26/go-get-%E6%8A%A5%E9%94%99410-Gone/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Angle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="嘻嘻">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/26/go-get-%E6%8A%A5%E9%94%99410-Gone/" class="post-title-link" itemprop="url">go get 报错410 Gone</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-26 11:08:48" itemprop="dateCreated datePublished" datetime="2021-05-26T11:08:48+08:00">2021-05-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-04 16:21:35" itemprop="dateModified" datetime="2021-06-04T16:21:35+08:00">2021-06-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><blockquote>
<p>go版本<code>go1.16.3</code>使用命令<code>go get xxx@xxx</code>拉取私有库时发现会报错410Gone</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get xxx@xxx: xxx: verifying module: xxx: reading https://goproxy.io/sumdb/sum.golang.org/lookup/xxx: 410 Gone</span><br><span class="line">	server response: not found:xxx: unrecognized import path <span class="string">&quot;xxx&quot;</span>: https fetch: Get <span class="string">&quot;xxx?go-get=1&quot;</span>: dial tcp xxx.xx.xx.xx:443: connect: connection refused</span><br></pre></td></tr></table></figure>
<blockquote>
<p>看起来走了proxy代理。目测是<code>proxy</code>配置有问题。但是检查发现<code>GONOPROXY</code>和<code>GONOPROXY</code>配置都是OK的。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//异常环境变量</span><br><span class="line"><span class="built_in">export</span> GOPROXY=https://goproxy.cn,direct</span><br><span class="line"><span class="built_in">export</span> GONOPROXY=xxx.xxx.xxx</span><br><span class="line"><span class="built_in">export</span> GOPRIVATE=xxx.xxx.xxx</span><br></pre></td></tr></table></figure>
<blockquote>
<p>该配置在另外一台电脑正常工作。</p>
</blockquote>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><blockquote>
<p>翻了无数网友的经验贴发现是<code>GONOSUMDB</code>也需要设置。查看了工作正常的机器和新机器的设置，的确有差异。加上<code>export GONOSUMDB=xxx.xxx.xxx</code>后工作正常</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//正常环境变量</span><br><span class="line"><span class="built_in">export</span> GOPROXY=https://goproxy.cn,direct</span><br><span class="line"><span class="built_in">export</span> GONOPROXY=xxx.xxx.xxx</span><br><span class="line"><span class="built_in">export</span> GOPRIVATE=xxx.xxx.xxx</span><br><span class="line"><span class="built_in">export</span> GONOSUMDB=xxx.xxx.xxx</span><br></pre></td></tr></table></figure>

<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><blockquote>
<ul>
<li>环境变量 <code>GOSUMDB</code> 可以用来配置你使用哪个校验服务器和公钥来做依赖包的校验.</li>
<li>如果你的代码仓库或者模块是私有的，那么它的校验值不应该出现在互联网的公有数据库里面，但是我们本地编译的时候默认所有的依赖下载都会去尝试做校验，这样不仅会校验失败，更会泄漏一些私有仓库的路径等信息，我们可以使用<code>GONOSUMDB</code>这个环境变量来设置不做校验的代码仓库，它可以设置多个匹配路径，用逗号相隔. 举个例子<code>GONOSUMDB=*.example.com,xxx.io/private</code></li>
</ul>
</blockquote>
<h3 id="proxy的环境变量说明"><a href="#proxy的环境变量说明" class="headerlink" title="proxy的环境变量说明"></a>proxy的环境变量说明</h3><ul>
<li><a target="_blank" rel="noopener" href="https://goproxy.io/zh/docs/introduction.html">https://goproxy.io/zh/docs/introduction.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Angle</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Angle</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
